# ============================================
# Configuration Apache pour Nuxt.js avec Phusion Passenger
# Fichier : /home/fggxbsyg/public_html/new/.htaccess
# ============================================

# ============================================
# PASSENGER CONFIGURATION
# ============================================

# Activer Passenger
PassengerEnabled on

# Chemin racine de l'application
PassengerAppRoot /home/fggxbsyg/public_html/new

# Type d'application
PassengerAppType node

# Fichier de démarrage (IMPORTANT: utiliser app.js, pas directement index.mjs)
PassengerStartupFile app.js

# Chemin vers Node.js (version 22)
PassengerNodejs /home/fggxbsyg/nodevenv/public_html/new/22/bin/node

# ============================================
# ENVIRONMENT VARIABLES
# ============================================

# Mode production
SetEnv NODE_ENV production

# Host et Port
SetEnv HOST 0.0.0.0
SetEnv PORT 3000

# Nuxt-specific
SetEnv NITRO_PORT 3000
SetEnv NITRO_HOST 0.0.0.0

# ============================================
# PASSENGER PERFORMANCE
# ============================================

# Nombre minimum d'instances
PassengerMinInstances 1

# Nombre maximum de processus
PassengerMaxPoolSize 2

# Nombre maximum de requêtes avant restart
PassengerMaxRequests 1000

# Temps avant mise en veille (secondes)
PassengerPoolIdleTime 300

# Temps de démarrage maximum (secondes)
PassengerStartTimeout 90

# Mémoire maximale par processus (300 MB)
PassengerMaxRequestQueueSize 100

# ============================================
# ERROR HANDLING & DEBUG
# ============================================

# Afficher les erreurs détaillées (activer temporairement si erreur)
PassengerFriendlyErrorPages on

# Environnement (production ou development)
# PassengerAppEnv development
PassengerAppEnv production

# ============================================
# REWRITE RULES
# ============================================

<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteBase /
  
  # Force HTTPS (décommenter si vous avez SSL)
  # RewriteCond %{HTTPS} off
  # RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
  
  # Ne pas rediriger les fichiers réels
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  
  # Laisser Passenger gérer toutes les requêtes
  RewriteRule ^(.*)$ / [L]
</IfModule>

# ============================================
# SECURITY HEADERS
# ============================================

<IfModule mod_headers.c>
  # Prévenir le MIME type sniffing
  Header always set X-Content-Type-Options "nosniff"
  
  # Protection contre le clickjacking
  Header always set X-Frame-Options "SAMEORIGIN"
  
  # Protection XSS
  Header always set X-XSS-Protection "1; mode=block"
  
  # Referrer Policy
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  
  # Content Security Policy (ajuster selon vos besoins)
  # Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
  
  # Remove Server header
  Header unset Server
  Header unset X-Powered-By
</IfModule>

# ============================================
# COMPRESSION
# ============================================

<IfModule mod_deflate.c>
  # Activer la compression pour les types de fichiers textuels
  AddOutputFilterByType DEFLATE text/html
  AddOutputFilterByType DEFLATE text/plain
  AddOutputFilterByType DEFLATE text/xml
  AddOutputFilterByType DEFLATE text/css
  AddOutputFilterByType DEFLATE text/javascript
  AddOutputFilterByType DEFLATE application/javascript
  AddOutputFilterByType DEFLATE application/x-javascript
  AddOutputFilterByType DEFLATE application/json
  AddOutputFilterByType DEFLATE application/xml
  AddOutputFilterByType DEFLATE application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml
  AddOutputFilterByType DEFLATE application/atom+xml
  AddOutputFilterByType DEFLATE image/svg+xml
  
  # Ne pas compresser les images déjà compressées
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp)$ no-gzip
</IfModule>

# ============================================
# BROWSER CACHING
# ============================================

<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresDefault "access plus 1 month"
  
  # Images
  ExpiresByType image/jpg "access plus 1 year"
  ExpiresByType image/jpeg "access plus 1 year"
  ExpiresByType image/gif "access plus 1 year"
  ExpiresByType image/png "access plus 1 year"
  ExpiresByType image/webp "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType image/x-icon "access plus 1 year"
  
  # CSS et JavaScript
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType text/javascript "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType application/x-javascript "access plus 1 month"
  
  # Fonts
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType font/otf "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType application/font-woff "access plus 1 year"
  
  # HTML (pas de cache pour les pages dynamiques)
  ExpiresByType text/html "access plus 0 seconds"
  
  # JSON, XML
  ExpiresByType application/json "access plus 0 seconds"
  ExpiresByType application/xml "access plus 0 seconds"
  ExpiresByType text/xml "access plus 0 seconds"
</IfModule>

# ============================================
# CACHE CONTROL HEADERS
# ============================================

<IfModule mod_headers.c>
  # Cache pour les assets statiques
  <FilesMatch "\.(ico|jpg|jpeg|png|gif|webp|svg|css|js|woff|woff2|ttf|otf)$">
    Header set Cache-Control "max-age=31536000, public, immutable"
  </FilesMatch>
  
  # Pas de cache pour HTML
  <FilesMatch "\.(html|htm)$">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires 0
  </FilesMatch>
</IfModule>

# ============================================
# FILE ACCESS PROTECTION
# ============================================

# Bloquer l'accès aux fichiers sensibles
<FilesMatch "^\.">
  Order allow,deny
  Deny from all
</FilesMatch>

# Protéger les fichiers de configuration
<FilesMatch "(^#.*#|\.(bak|conf|dist|fla|in[ci]|log|psd|sh|sql|sw[op])|~)$">
  Order allow,deny
  Deny from all
</FilesMatch>

# Protéger package.json, etc.
<FilesMatch "(package\.json|package-lock\.json|\.env|\.git)">
  Order allow,deny
  Deny from all
</FilesMatch>

# ============================================
# ERROR DOCUMENTS
# ============================================

# Pages d'erreur personnalisées (optionnel)
# ErrorDocument 404 /404.html
# ErrorDocument 500 /500.html

# ============================================
# ADDITIONAL SETTINGS
# ============================================

# Désactiver le listing des répertoires
Options -Indexes

# Suivre les liens symboliques
Options +FollowSymLinks

# UTF-8 par défaut
AddDefaultCharset UTF-8

# ============================================
# FIN DE LA CONFIGURATION
# ============================================
